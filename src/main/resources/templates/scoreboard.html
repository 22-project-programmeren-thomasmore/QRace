<!DOCTYPE html>
<html lang="nl-BE" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments\head-header-footer :: head"></head>
<head>
    <!-- js library -->
    <script src="/js/translator.js"></script>
    <script src="/js/translations.js"></script>
    <!-- Title -->
    <title>Scoreboard</title>
</head>

<body>
<header th:replace="fragments\head-header-footer :: header"></header>
<!-- content -->

<div class="container">
    <h1 class="my-4">Your Score</h1>
    <div class="table-responsive">
        <table class="table">
            <thead>
            <tr>
                <th>Id</th>
                <th>User Name</th>
                <th>Score</th>
                <th>Highscore Date</th>
                <th>Game Time</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td><span id="localId"></span></td>
                <td><span id="localUser"></span></td>
                <td><span id="localScore"></span></td>
                <td><span id="localDate"></span></td>
                <td><span id="localGameTime"></span></td>
            </tr>
            </tbody>
        </table>
    </div>

    <h1 class="my-4">Race details</h1>
    <div class="table-responsive">
        <table class="table" id="race-details-table">
            <thead>
            <tr>
                <th>Correct?</th>
                <th>Question</th>
                <th>Correct Answer</th>
                <th>User Answer</th>
                <th>Time</th>
            </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>

    <h1 class="my-4">All Scores</h1>
    <div class="form-group">
        <select class="form-control" id="sort-select">
            <option value="Id">Default (Id)</option>
            <option value="Username">Username (a-z)</option>
            <option value="Highscore">Highscore (Descending)</option>
            <option value="Date">Date</option>
        </select>
    </div>

    <div class="table-responsive">
        <table class="table" id="highscore-table">
            <thead>
            <tr>
                <th>Id</th>
                <th>User Name</th>
                <th>Score</th>
                <th>Highscore Date</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="score : ${highscores}">
                <td>
                    <span class="form-control-id" data-field="id" th:text="${score.id}"></span>
                </td>
                <td>
                    <span class="editable" data-field="userName" th:text="${score.userName}"></span>
                </td>
                <td>
                            <span class="editable" data-field="score" data-id="${score.id}"
                                  th:text="${score.score}"></span>
                </td>
                <td>
                            <span class="editable" data-field="highscoreDate" data-id="${score.id}"
                                  th:text="${#dates.format(score.highscoreDate, 'yyyy-MM-dd')}"></span>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
    <script th:inline="javascript">
        $(document).ready(function () {

            $("#sort-select").change(function () {
                var sortValue = $(this).val();
                console.log(sortValue)

                if (sortValue === "Username") {
                    sortTableByUserName();
                } else if (sortValue === "Highscore") {
                    sortTableByHighscore();
                } else if (sortValue === "Date") {
                    sortTableByDate();
                } else {
                    resetTable();
                }
            });

            function sortTableByUserName() {
                var sortedRows = $("#highscore-table tbody tr").toArray().sort(function (a, b) {
                    var userNameA = $(a).find('.editable[data-field="userName"]').text();
                    var userNameB = $(b).find('.editable[data-field="userName"]').text();
                    return userNameA.localeCompare(userNameB);
                });

                $("#highscore-table tbody").empty().append(sortedRows);
            }

            function sortTableByHighscore() {
                var sortedRows = $("#highscore-table tbody tr").toArray().sort(function (a, b) {
                    var scoreA = parseInt($(a).find('.editable[data-field="score"]').text());
                    var scoreB = parseInt($(b).find('.editable[data-field="score"]').text());
                    return scoreB - scoreA;
                });

                $("#highscore-table tbody").empty().append(sortedRows);
            }

            function sortTableByDate() {
                var sortedRows = $("#highscore-table tbody tr").toArray().sort(function (a, b) {
                    var dateA = new Date($(a).find('.editable[data-field="highscoreDate"]').text());
                    var dateB = new Date($(b).find('.editable[data-field="highscoreDate"]').text());
                    return dateB - dateA;
                });

                $("#highscore-table tbody").empty().append(sortedRows);
            }

            function resetTable() {
                var originalRows = Array.from($("#highscore-table tbody tr")).sort(function (a, b) {
                    var idA = parseInt($(a).find('.form-control-id[data-field="id"]').text());
                    var idB = parseInt($(b).find('.form-control-id[data-field="id"]').text());
                    return idA - idB;
                });

                $("#highscore-table tbody").empty().append(originalRows);
            }

            function fetchQuestion(id) {
                return fetch('/api/questions')
                    .then(response => response.ok ? response.json() : Promise.reject("Failed to fetch questions"))
                    .then(questions => {
                        const question = questions.find(q => q.id === id);

                        if (question) {
                            return question;
                        } else {
                            throw new Error(`Question with ID ${id} not found.`);
                        }
                    });
            }


            var localScoreData = localStorage.getItem("track progress");
            var data = JSON.parse(localScoreData);

            // Access the race details
            var groups = data.groups;

            for (var group in groups) {
                if (groups.hasOwnProperty(group)) {
                    var answeredQuestions = groups[group].answeredQuestions;
                    // console.log(answeredQuestions);

                    for (var questionId in answeredQuestions) {
                        if (answeredQuestions.hasOwnProperty(questionId)) {
                            var answeredQuestion = answeredQuestions[parseInt(questionId)];

                            var recordTime = answeredQuestion.recordTime;
                            var correct = answeredQuestion.correct;
                            var answer = answeredQuestion.answer;
                            console.log(answer)

                            // Retrieve the question details using fetchQuestion
                            fetchQuestion(parseInt(questionId))
                                .then(question => {
                                    console.log(question);  // Log the fetched question
                                    var newRow = $("<tr>");
                                    newRow.append($("<td>").text(correct ? "Yes" : "No"));
                                    newRow.append($("<td>").text(question.questionText));
                                    newRow.append($("<td>").text(question.correctAnswer));
                                    newRow.append($("<td>").text(answer));
                                    newRow.append($("<td>").text(recordTime));

                                    $("#race-details-table tbody").append(newRow);
                                })
                                .catch(error => {
                                    console.error(error);
                                    console.log('Error fetching question with ID:', questionId);  // Log error message
                                });

                        }
                    }
                }
            }

        });

        var username = localStorage.getItem("userName");
        $("#localUser").text(username);
        var localScoreData = localStorage.getItem("track progress");
        // Parse the JSON data
        var data = JSON.parse(localScoreData);

        // Access the score
        var localScore = data.score;
        $("#localScore").text(localScore);

        var localGameTime = data.totalTime;
        $("#localGameTime").text(localGameTime);

        var today = new Date();

        var year = today.getFullYear(); // Get the current year (e.g., 2023)
        var month = today.getMonth() + 1; // Get the current month (returns a value from 0 to 11, so adding 1 to get the actual month number)
        var day = today.getDate(); // Get the current day of the month

        // Format the date as desired (e.g., YYYY-MM-DD)
        var formattedDate = year + "-" + month.toString().padStart(2, "0") + "-" + day.toString().padStart(2, "0");

        $("#localDate").text(formattedDate);

        var rows = $("#highscore-table tbody tr");
        var foundRow = null;

        rows.each(function () {
            var row = $(this);
            var userName = row.find('.editable[data-field="userName"]').text();

            if (userName === username) {
                foundRow = row;
                return false; // Exit the loop early if the row is found
            }
        });

        if (foundRow) {
            var id = foundRow.find('.form-control-id').text();
            var score = foundRow.find('.editable[data-field="score"]').text();
            var highscoreDate = foundRow.find('.editable[data-field="highscoreDate"]').text();

            $("#localId").text(id);
            $("#localScore").text(score);
            $("#localDate").text(highscoreDate);
        } else {
            console.log("Row not found for username:", username);
        }
    </script>
</div>
<!-- JS library -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

</body>

</html>
